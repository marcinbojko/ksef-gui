---
# KSeFCli — production docker-compose
# Includes: Traefik (reverse proxy), ksefcli (GUI), Ofelia (scheduler)
#
# Usage:
#   cp .env.example .env && $EDITOR .env
#   docker compose up -d

services:

  # ── Traefik — reverse proxy ───────────────────────────────────────────────
  traefik:
    image: traefik:${TRAEFIK_TAG:-v3.3}
    container_name: traefik
    restart: unless-stopped
    stop_grace_period: 10s
    ports:
      - "80:80"
      - "443:443"
    networks:
      - front
      - back
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-acme:/etc/traefik/acme
    command:
      - --log.level=INFO
      - --log.format=json
      - --accesslog=true
      - --accesslog.format=json
      - --api.dashboard=false
      - --ping=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=front
      - --entrypoints.http.address=:80
      - --entrypoints.http.http.redirections.entrypoint.to=https
      - --entrypoints.http.http.redirections.entrypoint.scheme=https
      - --entrypoints.http.http.redirections.entrypoint.permanent=true
      - --entrypoints.https.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/etc/traefik/acme/acme.json
      - --certificatesresolvers.letsencrypt.acme.tlschallenge=true
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    labels:
      traefik.enable: "false"

  # ── KSeF GUI ─────────────────────────────────────────────────────────────
  ksefcli:
    image: ghcr.io/marcinbojko/ksef-gui:${KSEFCLI_TAG:-latest}
    build:
      context: .
      args:
        APP_VERSION: ${KSEFCLI_TAG:-dev}
    container_name: ksefcli
    restart: unless-stopped
    stop_grace_period: 15s
    expose:
      - "${KSEFCLI_PORT:-18150}"
    networks:
      - front
      - back
    volumes:
      - ksefcli-config:/root/.config/ksefcli
      - ./output:/data
      - ksefcli-cache:/root/.cache/ksefcli
    environment:
      TZ: ${TZ:-UTC}
      DOTNET_SYSTEM_GLOBALIZATION_INVARIANT: "true"
    command:
      - Gui
      - --lan
      - -o
      - /data
      - --pdf
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:${KSEFCLI_PORT:-18150}/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      traefik:
        condition: service_healthy
    labels:
      traefik.enable: "true"
      # HTTP router (redirect handled by Traefik entrypoint)
      traefik.http.routers.ksefcli.entrypoints: http
      traefik.http.routers.ksefcli.rule: Host(`${KSEFCLI_HOSTNAME}`)
      # HTTPS router
      traefik.http.routers.ksefcli-secure.entrypoints: https
      traefik.http.routers.ksefcli-secure.rule: Host(`${KSEFCLI_HOSTNAME}`)
      traefik.http.routers.ksefcli-secure.tls: "true"
      traefik.http.routers.ksefcli-secure.tls.certresolver: ${TRAEFIK_CERT_RESOLVER:-letsencrypt}
      traefik.http.routers.ksefcli-secure.middlewares: ksefcli-auth@docker
      traefik.http.routers.ksefcli-secure.service: ksefcli
      # Service
      traefik.http.services.ksefcli.loadbalancer.server.port: "${KSEFCLI_PORT:-18150}"
      # Basic-auth middleware (leave empty to disable)
      # Generate hash: htpasswd -nb <user> <pass>  (double $ in .env)
      traefik.http.middlewares.ksefcli-auth.basicauth.users: "${KSEFCLI_BASICAUTH_USERS:-}"

  # ── Ofelia — job scheduler ────────────────────────────────────────────────
  ofelia:
    image: mcuadros/ofelia:${OFELIA_TAG:-latest}
    container_name: ofelia
    restart: unless-stopped
    depends_on:
      ksefcli:
        condition: service_healthy
    networks:
      - back
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./ofelia/config.ini:/etc/ofelia/config.ini:ro
    command:
      - daemon
      - --config=/etc/ofelia/config.ini
    labels:
      traefik.enable: "false"

# ── Networks ─────────────────────────────────────────────────────────────────
networks:
  front:
    driver: bridge          # Traefik ↔ ksefcli (public-facing)
  back:
    driver: bridge
    internal: true          # ksefcli ↔ ofelia only; no direct internet access

# ── Volumes ───────────────────────────────────────────────────────────────────
volumes:
  ksefcli-config:
    driver: local
  ksefcli-cache:
    driver: local
  traefik-acme:
    driver: local
